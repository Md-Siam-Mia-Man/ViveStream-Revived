name: Release Build

on:
  workflow_dispatch:
    inputs:
      clean_cache:
        description: "Clean NPM cache"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  discussions: write

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Linux
            os: ubuntu-24.04
            build_command: npm run build:linux:ci
            artifact_path: |
              release/linux/*.AppImage
              release/linux/*.deb
              release/linux/*.rpm
              release/linux/*.snap
              release/linux/*.flatpak
              release/linux/*.tar.gz
              release/linux/*.tar.xz

          - platform: Windows
            os: windows-latest
            build_command: node helpers/builder.js --win --target=nsis,msi
            artifact_path: |
              release/win/*.exe
              release/win/*.msi

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Checkout Portable Python
        uses: actions/checkout@v4
        with:
          repository: Md-Siam-Mia-Main/python-portable
          path: python-portable
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25"
          cache: "npm"

      - name: Reassemble Large Files
        run: npm run files:join

      - name: Install System Dependencies (Linux)
        if: matrix.platform == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm libarchive-tools flatpak flatpak-builder fakeroot dpkg-dev libsecret-1-dev libfuse2 libgl1-mesa-dev build-essential graphicsmagick
          sudo snap install snapcraft --classic

      - name: Clean NPM Cache (Optional)
        if: ${{ inputs.clean_cache }}
        run: npm cache clean --force

      - name: Configure NPM Retries
        run: |
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000

      - name: Install NPM Dependencies
        run: npm ci

      - name: Hydrate Python Environment
        run: npm run env:update

      - name: Verify Windows Assets
        if: matrix.platform == 'Windows'
        shell: powershell
        run: |
          if (-not (Test-Path "build/installer.nsh")) {
            Write-Error "build/installer.nsh NOT FOUND. Build will fail."
            exit 1
          }

      - name: Verify Version
        shell: bash
        id: version_check
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "val=$PKG_VERSION" >> $GITHUB_OUTPUT
          # Handle both tag trigger and manual dispatch
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_VERSION=${GITHUB_REF_NAME#v}
            if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
              echo "::error::Version mismatch! package.json ($PKG_VERSION) vs Tag ($TAG_VERSION)"
              exit 1
            fi
            echo "Version Verified: $PKG_VERSION"
          else
            echo "Manual run, skipping version/tag strict match check."
          fi

      - name: Build Application
        shell: bash
        run: |
          ${{ matrix.build_command }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean Unwanted Files
        shell: bash
        run: |
          find release -name "*.blockmap" -delete
          find release -name "*.yml" -delete

      - name: Create Source Archive
        if: matrix.platform == 'Linux'
        shell: bash
        run: |
          # Use zip for reliability, label clearly
          zip -r release/linux/ViveStream-Source-v${{ steps.version_check.outputs.val }}.zip . \
            -x "node_modules/*" "python-portable/*" ".git/*" "release/*" "*.log" "helpers/large-file-manager.js"

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ matrix.artifact_path }}
            release/linux/ViveStream-Source-*.zip
          draft: true
          prerelease: false
          make_latest: true
          generate_release_notes: true
          name: "ViveStream Revived v${{ steps.version_check.outputs.val }} ðŸš€"
          tag_name: "v${{ steps.version_check.outputs.val }}"
          body: |
            ## ðŸŒŸ ViveStream Revived - What's New?
            
            Welcome to the latest version of **ViveStream**! This release brings performance improvements, bug fixes, and better stability.
            
            ### ðŸ› ï¸ Installation
            - **Windows**: Download the `.exe` or `.msi` installer.
            - **Linux**: Use the `AppImage`, `.deb`, `.rpm`, `.snap`, `.flatpak` or tarballs.
            
            ---
            ### âš ï¸ Security Note (Code Signing)
            > **Notice**: This application is not code-signed because the developer does not currently have a commercial signing certificate. 
            > 
            > - **Windows**: You may see a "Microsoft Defender SmartScreen" warning. Click **"More info"** and then **"Run anyway"**.
            
            Rest assured, the application is safe to use and the source code is provided below for transparency.
            
            ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts to Run
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-Builds
          path: |
            ${{ matrix.artifact_path }}
            release/linux/ViveStream-Source-*.zip
          retention-days: 5
